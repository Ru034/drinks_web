<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <link href="../styles/delivery.css" rel="stylesheet">
  <title>外送</title>
</head>

<body>
  <!-- 檢查是否有 user cookie，有的話顯示使用者帳號，否則跳轉到登入頁面 -->

  <div class="top-nav">
    <div class="user-account"></div>
    <a href="login.html">
      <img src="../images/login.png" alt="登入圖示" style="width:50px; height:50px;">
    </a>
    <a href="home.html">首頁</a>
    <a href="most_new.html">最新資訊</a>
    <a href="drinks.html">飲品介紹</a>
    <a href="delivery.html">外送</a>
  </div>

  <div class="login-window"></div>
  <div class="shopping-cart">
    <h2>購物車</h2>
    <ul class="cart-items">
      <!-- 這裡將動態顯示購物車內容 -->
    </ul>
    <button onclick="checkout()">結帳</button>
  </div>
  <div class="drinks-list"></div> <!-- 用來顯示飲品列表的容器 -->

  <script>
    // 檢查用戶是否已登入，並顯示用戶帳號
    function checkLogin() {
      var userCookie = getCookie('user');
      if (userCookie) {
        document.querySelector('.login-window').textContent = userCookie;
      } else {
        // 如果沒有登入，導向登入頁面
        window.location.href = 'login.html';
      }
    }

    // 獲取 cookie 的函數
    function getCookie(name) {
      var cookieArr = document.cookie.split(';');
      for (var i = 0; i < cookieArr.length; i++) {
        var cookiePair = cookieArr[i].split('=');
        if (name === cookiePair[0].trim()) {
          return decodeURIComponent(cookiePair[1]);
        }
      }
      return null;
    }

    // 當文檔加載完成後執行檢查
    document.addEventListener('DOMContentLoaded', function () {
      checkLogin();
      fetchDrinks();
    });

    // 獲取飲品列表的函數
    function fetchDrinks() {
      fetch('../php/delivery.php')
        .then(response => response.text())
        .then(data => {
          document.querySelector('.drinks-list').innerHTML = data;
        });
    }

    let cart = [];

    function updateSweetness(drinkId) {
      let sweetness = document.getElementById('sweetness_select_' + drinkId).value;
      document.getElementById('sweetness_' + drinkId).value = sweetness;
    }

    function updateIce(drinkId) {
      let ice = document.getElementById('ice_select_' + drinkId).value;
      document.getElementById('ice_' + drinkId).value = ice;
    }

    function addToCart(drinkId, drinkName) {
      let item = {
        drinkId: drinkId,
        drinkName: drinkName,
        sweetness: document.getElementById('sweetness_' + drinkId).value,
        ice: document.getElementById('ice_' + drinkId).value
      };

      cart.push(item);
      updateCartUI();
    }

    function updateCartUI() {
      let cartItems = document.querySelector('.cart-items');
      cartItems.innerHTML = '';
      cart.forEach(item => {
        let listItem = document.createElement('li');
        listItem.textContent = `飲品名: ${item.drinkName}, 甜度: ${item.sweetness}, 冰塊: ${item.ice}`;
        cartItems.appendChild(listItem);
      });
    }

    function checkout() {
      let userCookie = getCookie('user');
      if (!userCookie) {
        alert('請先登入');
        window.location.href = 'login.html';
        return;
      }

      // 將購物車內容送到後端
      fetch('../php/checkout.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ cart: cart, user: userCookie })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('結帳成功');
            cart = [];
            updateCartUI();
          } else {
            alert('結帳失敗，請稍後再試');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('結帳失敗，請稍後再試');
        });
    }
  </script>
</body>

</html>
